package parse

import (
	"testing"
)

var doc1 = `{
  "_id": "1448795ef1d3e2aede1ff6ca4eca7271",
  "_rev": "1-a6104d46afbf0a5fa496e8455fc81db1",
  "url": "http://blog.fmpwizard.com/blog/adding-fields-dynamically-lift",
  "html": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta content=\"text/html; charset=UTF-8\" http-equiv=\"content-type\">\n    <meta content=\"\" name=\"description\">\n    <meta content=\"\" name=\"keywords\">\n    <title>Dynamically adding fields to a Lift application</title>\n        <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->\n                                   <!--[if lt IE 9]>\n                                     <script src=\"https://html5shim.googlecode.com/svn/trunk/html5.js\"></script>\n                                   <![endif]-->\n    <link href=\"//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">   \n\n\t\n<link rel=\"alternate\" type=\"application/rss+xml\" href=\"/rss.xml\"></head>\n<body>\n<div class=\"container\">\n      <div role=\"navigation\" class=\"navbar navbar-default\">\n        <div class=\"container-fluid\">\n          <div class=\"navbar-header\">\n            <button data-target=\".navbar-collapse\" data-toggle=\"collapse\" class=\"navbar-toggle\" type=\"button\">\n              <span class=\"sr-only\">Toggle navigation</span>\n              <span class=\"icon-bar\"></span>\n              <span class=\"icon-bar\"></span>\n              <span class=\"icon-bar\"></span>\n            </button>\n            <a class=\"navbar-brand\" href=\"#\">fmpwizard</a>\n          </div>\n          <div class=\"navbar-collapse collapse\">\n            <ul class=\"nav navbar-nav\">\n              <li><a href=\"/\">Home</a></li><li><a href=\"/404\"></a></li><li><a href=\"/about\">About</a></li><li><a href=\"/archive\">Archive</a></li>\n            </ul>\n          </div>\n        </div>\n      </div>\n      <div class=\"content\">\n        \n                <h1 id=\"dynamically-adding-fields-to-a-lift-application\">Dynamically adding fields to a Lift application</h1>\n<p>A question that I see on the mailing list from time to time is how to dynamically add fields to a page.</p>\n<p>The usual answer is that they cannot really do that, at least in a clean way, but we offer a few work arounds. One of them is to declare x number of fields, and just use jQuery to hide/show them.</p>\n<p>This past week I had the same requirement at work. One of our Lift applications sends and email invite, and we want users to be able to add x number of reminder emails to follow up the initial invite email.</p>\n<p>At first I told my team that we would need to limit the number of reminders to 10, and see if our users could live with it, they were ok with it, but I just could not live with that.</p>\n<p>I was right there, staring at IntelliJ, I typed the usual  <code>def render = {}</code> and then I could not type those 10 variables and 10 css selector transform (well 20 because we needed two fields per email reminder).</p>\n<p>Then I remembered this one <a href=\"https://groups.google.com/d/topic/liftweb/mrRWu0SOymQ/discussion\">email</a> on the mailing list. There, Antoine shows one way to add fields to a page. While it works, in my case I needed to add two related fields at the time, and I didn't want to have to zip two lists to get my original data.</p>\n<p>So I was back at the drawing board. I had one solution that was really ugly, then I had another solution, but it was too fragile for my use case, and the thing with me is that I love being proud of the code I write, not just the open source code, but also the closed source, but I was running out of time, so I started talking with <a href=\"https://twitter.com/eltimn/\">Tim Nelson</a> and the solution came up, just use plain html fields, and use <code>jsonCall</code> to send the data to the Lift server.</p>\n<h2 id=\"the-idea\">The idea.</h2>\n<p>The idea is pretty simple, you have your default number of fields on the screen, you do not have any Lift closure associated with them, they are plain old html forms on an html page. I added two buttons, one to <strong>add</strong> and one to <strong>remove</strong> fields.</p>\n<p><img alt=\"Initial fields\" src=\"/images/picture1.jpg\"></p>\n<p>You can find the JavaScript code on <a href=\"https://github.com/fmpwizard/lift_starter_2.4/blob/lift_dynamic_fields/src/main/webapp/js/myjsfunctions.js\">github</a>. (Note how I'm using an external JavaScript file to hold my functions, this is something else I learned from Tim not too long ago.)</p>\n<p>You press the blue button, and the <code>div</code> that holds the two boxes is duplicated, I change the name of each input field and I'm done.</p>\n<p>The next part of the puzzle is the <code>Finish</code> button. I needed a way to call a Lift method from JavaScript. You normally do this by using <code>ajaxCall/jsonCall</code> but here I added a small twist, I'm using a <strong>named ajax function</strong>, I had seen this idea mentioned before and recently <strong>Brent Sowers</strong>  <a href=\"https://groups.google.com/d/topic/liftweb/EqzKHbL6A5E/discussion\">wrote</a> how he does it.</p>\n<h2 id=\"some-code\">Some code.</h2>\n<p>I have this snippet method</p>\n<pre><code>def sendToServer = {\n  &quot;#sendToServer&quot; #&gt; Script(\n    Function(ourFnName, List(&quot;paramName&quot;),\n      SHtml.jsonCall(JsVar(&quot;paramName&quot;), (s: JValue) =&gt; addRowsToDB(s) )._2.cmd //use on lift &gt;= 2.5\n      //SHtml.jsonCall(JsVar(&quot;paramName&quot;), (s: Any) =&gt; addRowsToDB(s) )._2.cmd //Use this on Lift &lt; 2.5\n    )\n  ) &amp;\n  &quot;#initDynamic&quot; #&gt; Script(JE.JsRaw(js2).cmd)\n}\n</code></pre>\n<p>that adds a JavaScript function to the page, that in turn executes a <code>jsonCall</code> to the server. This is the value of <code>js2</code>:</p>\n<pre><code>  val js2 =\n&quot;&quot;&quot;\n  |            $(document).ready(function() {\n  |              $('#btnDel').attr('disabled','disabled');\n  |              window.dyTable = new window.fmpwizard.views.DynamicFields();\n  |              window.dyTable.addFields();\n  |              window.dyTable.removeFields();\n  |            });\n&quot;&quot;&quot;.stripMargin\n</code></pre>\n<p>My <code>render</code> method is pretty simple:</p>\n<pre><code>//This is used to prevent replay attacks\nval ourFnName = Helpers.nextFuncName\n    \ndef render = {\n  &quot;#next [onclick]&quot; #&gt; JE.JsRaw(js1)\n}\n    \nval js1 =\n&quot;&quot;&quot;\n  |window.dyTable = new window.fmpwizard.views.DynamicFields();\n  |window.dyTable.collectFormData(%s);\n&quot;&quot;&quot;.format(ourFnName).stripMargin\n</code></pre>\n<p>The JavaScript function collectFormData is:</p>\n<pre><code>self.collectFormData = function(fnName) {\n  var formData = new Array();\n  $(&quot;.emailContent&quot;).each(function() {\n    formData.push([$(this).val(), $(this).parent().children('input').val()]);\n  });\n  fnName(formData);\n};\n</code></pre>\n<p>So I walk down all the elements with the <code>class</code> attribute <code>.emailContent</code> and I push its value, and the value of the input field next to it, to an array. I then send this array to our named ajax function and then it is sent to the Lift server. Pay attention that I pass the name of the function to call using the fnName parameter, I added this to prevent replay attacks.</p>\n<p>On the server side I processed the array with this method:</p>\n<pre><code>private def addRowsToDB(x: JValue) : JsCmd ={\n  val res = for {\n    JArray(child) &lt;- x\n    JArray(List(JString(text), JString(n))) &lt;- child\n  } yield{\n    asInt(n).map( num =&gt; logger.info(&quot;The text we got was: %s and the related field value was: %s&quot;.format(text,num)))\n    //This is where you can store the data on a database.\n    asInt(n).map( num =&gt; (text, num))\n  }\n  JsCmds.Alert(&quot;The server got %s&quot; format res)\n}\n</code></pre>\n<p>And finally, this is the markup:</p>\n<pre><code>&lt;form data-lift=&quot;form.ajax&quot; action=&quot;#&quot; class=&quot;well form-inline&quot;&gt;\n  &lt;div data-lift=&quot;Sample&quot;&gt;\n    &lt;div id=&quot;input1&quot; class=&quot;clonedInput&quot;&gt;\n      &lt;label for=&quot;Text1&quot;&gt;Some textarea box&lt;/label&gt;&lt;br&gt;\n      &lt;textarea class=&quot;emailContent&quot; id=&quot;Text1&quot; rows=&quot;4&quot; cols=&quot;100&quot;&gt;&lt;/textarea&gt;&lt;br&gt;\n      &lt;hr&gt;\n      &lt;label for=&quot;runReminderInDays1&quot;&gt;Related numeric field: &lt;/label&gt;\n      &lt;input id=&quot;runReminderInDays1&quot; class=&quot;runReminderInDays&quot; size=&quot;2&quot;&gt;\n    &lt;/div&gt;\n    &lt;div&gt;\n      &lt;input class=&quot;btn btn-primary&quot; type=&quot;button&quot; id=&quot;btnAdd&quot; value=&quot;add another row&quot; /&gt;\n      &lt;input class=&quot;btn btn-danger&quot; type=&quot;button&quot; id=&quot;btnDel&quot; value=&quot;remove last row&quot; /&gt;\n    &lt;/div&gt;\n    &lt;div&gt;\n      &lt;button id=&quot;next&quot; value=&quot;Submit&quot; type=&quot;button&quot; class=&quot;btn&quot;&gt;&lt;Lift:Loc&gt;Finish&lt;/Lift:Loc&gt;&lt;/button&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;/form&gt;\n&lt;div data-lift=&quot;Sample.sendToServer&quot;&gt;\n  &lt;script id=&quot;sendToServer&quot;&gt;&lt;/script&gt;\n  &lt;script id=&quot;initDynamic&quot;&gt;&lt;/script&gt;\n&lt;/div&gt;\n</code></pre>\n<h2 id=\"sample-application\">Sample application.</h2>\n<p>This time i didn't publish a running application, but I did put the source code on github, so you can clone this <a href=\"https://github.com/fmpwizard/lift_starter_2.4/tree/lift_dynamic_fields\">repo</a> and you can try it out at home/work.</p>\n<h2 id=\"final-notes\">Final notes</h2>\n<p>I'm pretty happy with how all the pieces work together, it looks pretty clean and I don't think I have sacrificed any of Lift's core ideas by doing this. I am still wondering if this technique makes an application vulnerable to any hacking attack and if I find a way I'll update this post.</p>\n<p>Turns out there was a problem with the first implementation I wrote (about 1 hour ago), you could just call the JavaScript function that sends the data to the Lift server, and pass any parameters to it. So that would allow anyone to just submit any arbitrary value to our server, something we don;t want.</p>\n<p>To prevent this I now use <code>Helpers.nextFuncName</code> to generate a unique name for each user that comes to the application, and I then pass this value to the myCompanyjs.js file, so that the script knows which name to use.</p>\n<p>Thanks</p>\n<p>  Diego</p>\n\n              \n    </div>\n    <div id=\"after-content\"></div>\n  <div id=\"disqus_thread\"></div>\n  <script type=\"text/javascript\">\n    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */\n    var disqus_shortname = 'fmpwizard'; // required: replace example with your forum shortname\n\n    /* * * DON'T EDIT BELOW THIS LINE * * */\n    (function() {\n      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;\n      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';\n      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);\n    })();\n  </script>\n  <noscript>Please enable JavaScript to view the <a href=\"http://disqus.com/?ref_noscript\">comments powered by Disqus.</a></noscript>\n\n\n</div>\n<script>\n  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\n  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\n  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\n  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');\n\n  ga('create', 'UA-368436-11', 'telegr.am');\n  ga('send', 'pageview');\n\n</script>\n<script data-api-key=\"dd43b218-d1f5-49ae-4351-b9a191624a77\" async=\"true\" src=\"//skyboxanalytics.com/skybox.js\" type=\"text/javascript\">\n</script>\n<script src=\"//code.jquery.com/jquery-1.11.0.min.js\"></script>\n<script src=\"//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js\"></script>\n\n\n\n\n\t\n</body>\n</html>",
  "date": "2015-02-23T07:59:30.118308477Z"
}`

func mockedFetchChecker(url string) bool {
	return true
}

func TestExtractText(t *testing.T) {
	extracted := ExtractText([]byte(doc1))
	if extracted.Title != "Dynamically adding fields to a Lift application" {
		t.Errorf("ExtractText didn't give us expected result. It gave: %s\n", extracted.Title)
	}
	if len(extracted.H1) != 1 {
		t.Errorf("ExtractText didn't give us expected result: \n%+v\n\nIt gave: %d H1 elements\n", extracted, len(extracted.H1))
	}
	if len(extracted.H2) != 4 {
		t.Errorf("ExtractText didn't give us expected result: \n%+v\n\nIt gave: %d H2 elements\n", extracted, len(extracted.H2))
	}
}

func TestExtractLinks(t *testing.T) {
	extracted := ExtractLinks([]byte(doc1), "http://blog.fmpwizard.com", mockedFetchChecker)
	if len(extracted.URL) != 4 {
		t.Errorf("ExtractLinks didn't give us expected result. It gave: %d urls\n", len(extracted.URL))
	}
}
